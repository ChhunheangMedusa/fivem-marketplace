<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FiveM Store - Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation (same as index.html) -->
    <nav class="bg-gray-800 shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <h1 class="text-2xl font-bold text-blue-400">FiveM Store</h1>
          </div>
          <div class="hidden md:flex space-x-8">
            <a href="index.html" class="hover:text-blue-400 transition">Home</a>
            <a href="products.html" class="text-blue-400 font-semibold"
              >Products</a
            >
            <a href="categories.html" class="hover:text-blue-400 transition"
              >Categories</a
            >
            <a href="about.html" class="hover:text-blue-400 transition"
              >About</a
            >
          </div>
          <div class="flex items-center space-x-4">
            <div class="relative">
              <input
                type="text"
                id="navSearch"
                placeholder="Search..."
                class="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 w-40 md:w-64"
              />
              <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
            <a
              href="checkout.html"
              class="relative p-2 hover:text-blue-400 transition"
            >
              <i class="fas fa-shopping-cart text-xl"></i>
              <span
                id="cartCount"
                class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden"
                >0</span
              >
            </a>
            <button
              id="themeToggle"
              onclick="toggleTheme()"
              class="p-2 hover:text-blue-400 transition"
            >
              <i class="fas fa-moon"></i>
            </button>
          </div>
        </div>
        <div
          class="md:hidden flex justify-center space-x-6 py-3 border-t border-gray-700"
        >
          <a href="index.html" class="hover:text-blue-400 transition">Home</a>
          <a href="products.html" class="text-blue-400 font-semibold"
            >Products</a
          >
          <a href="categories.html" class="hover:text-blue-400 transition"
            >Categories</a
          >
          <a href="about.html" class="hover:text-blue-400 transition">About</a>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-8">All Products</h1>

      <!-- Search Bar -->
      <div class="max-w-2xl mx-auto mb-8">
        <div class="relative">
          <input
            type="text"
            id="searchInput"
            placeholder="Search products by name, description, or category..."
            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 border border-gray-700"
          />
          <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>
        <div id="searchResults" class="mt-2 text-sm text-gray-400 hidden">
          <!-- Search results info will appear here -->
        </div>
      </div>

      <!-- Filters and Sort -->
      <div class="flex flex-wrap gap-4 mb-8 justify-between">
        <div class="flex flex-wrap gap-4">
          <select
            id="categoryFilter"
            class="bg-gray-800 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 border border-gray-700"
          >
            <option value="all">All Categories</option>
            <option value="ESX">ESX</option>
            <option value="QB-Core">QB-Core</option>
            <option value="QBox">QBox</option>
          </select>

          <select
            id="sortSelect"
            class="bg-gray-800 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 border border-gray-700"
          >
            <option value="name">Sort by Name</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
            <option value="relevance">Relevance</option>
          </select>

          <button
            id="clearFilters"
            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition border border-gray-600"
          >
            Clear Filters
          </button>
        </div>

        <div class="flex items-center space-x-4">
          <span id="productCount" class="text-gray-400">Loading...</span>
        </div>
      </div>

      <!-- Products Grid -->
      <div
        id="productsGrid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8"
      >
        <!-- Products will be loaded here -->
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="hidden text-center py-12">
        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">No products found</h3>
        <p class="text-gray-400">Try adjusting your search or filters</p>
        <button
          id="resetSearch"
          class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition"
        >
          Reset Search
        </button>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="flex justify-center items-center space-x-2">
        <!-- Pagination will be generated here -->
      </div>
    </main>

    <script src="script.js"></script>
    <script>
      let allProducts = [];
      let currentPage = 1;
      const productsPerPage = 10;
      let currentSearchQuery = "";
      let currentSort = "name";

      // Function to get URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          category: params.get("category"),
        };
      }

      async function loadProductsPage() {
        const data = await loadData();
        allProducts = data.products;

        // Handle URL parameters
        const urlParams = getUrlParams();
        if (urlParams.category) {
          // Set category filter and search to show only this category
          document.getElementById("categoryFilter").value = urlParams.category;
          currentSearchQuery = urlParams.category.toLowerCase();
          document.getElementById("searchInput").value = urlParams.category;
          document.getElementById("navSearch").value = urlParams.category;
        }

        renderProducts();
        setupFilters();
        setupSearch();
        updateSearchInfo();
      }

      function setupSearch() {
        const searchInput = document.getElementById("searchInput");
        const navSearch = document.getElementById("navSearch");
        const resetSearchBtn = document.getElementById("resetSearch");

        // Main search functionality
        searchInput.addEventListener("input", (e) => {
          currentSearchQuery = e.target.value.trim().toLowerCase();
          currentPage = 1;
          renderProducts();
          updateSearchInfo();
        });

        // Navigation search functionality
        navSearch.addEventListener("input", (e) => {
          currentSearchQuery = e.target.value.trim().toLowerCase();
          currentPage = 1;
          renderProducts();
          updateSearchInfo();

          // Sync with main search input
          searchInput.value = e.target.value;
        });

        // Reset search button
        resetSearchBtn.addEventListener("click", () => {
          currentSearchQuery = "";
          searchInput.value = "";
          navSearch.value = "";
          currentPage = 1;

          // Check if we came from a category link - if so, keep the category filter
          const urlParams = getUrlParams();
          if (!urlParams.category) {
            document.getElementById("categoryFilter").value = "all";
          }

          renderProducts();
          updateSearchInfo();
        });
      }

      function updateSearchInfo() {
        const searchResults = document.getElementById("searchResults");
        const filteredProducts = filterAndSortProducts();

        if (currentSearchQuery) {
          searchResults.classList.remove("hidden");
          searchResults.textContent = `Found ${filteredProducts.length} products matching "${currentSearchQuery}"`;
        } else {
          searchResults.classList.add("hidden");
        }
      }

      function searchProducts(products, query) {
        if (!query) return products;

        return products.filter(
          (product) =>
            product.title.toLowerCase().includes(query) ||
            product.description.toLowerCase().includes(query) ||
            product.shortDescription.toLowerCase().includes(query) ||
            product.categories.some((cat) => cat.toLowerCase().includes(query))
        );
      }

      function filterAndSortProducts() {
        const categoryFilter = document.getElementById("categoryFilter").value;
        const sortSelect = document.getElementById("sortSelect").value;
        const urlParams = getUrlParams();

        currentSort = sortSelect;

        let filtered = allProducts;

        // Apply search filter
        if (currentSearchQuery) {
          filtered = searchProducts(filtered, currentSearchQuery);
        }

        // Apply category filter - URL parameter takes priority over dropdown
        const activeCategory = urlParams.category || categoryFilter;
        if (activeCategory !== "all") {
          filtered = filtered.filter((product) =>
            product.categories.includes(activeCategory)
          );
        }

        // Apply sorting
        switch (sortSelect) {
          case "price-low":
            filtered.sort((a, b) => a.price - b.price);
            break;
          case "price-high":
            filtered.sort((a, b) => b.price - a.price);
            break;
          case "relevance":
            // If there's a search query, sort by relevance
            if (currentSearchQuery) {
              filtered.sort((a, b) => {
                const aScore = getRelevanceScore(a, currentSearchQuery);
                const bScore = getRelevanceScore(b, currentSearchQuery);
                return bScore - aScore;
              });
            } else {
              filtered.sort((a, b) => a.title.localeCompare(b.title));
            }
            break;
          case "name":
          default:
            filtered.sort((a, b) => a.title.localeCompare(b.title));
            break;
        }

        return filtered;
      }

      function getRelevanceScore(product, query) {
        let score = 0;
        const lowerQuery = query.toLowerCase();

        // Title matches are most important
        if (product.title.toLowerCase().includes(lowerQuery)) {
          score += 10;
        }

        // Description matches
        if (product.description.toLowerCase().includes(lowerQuery)) {
          score += 5;
        }

        // Short description matches
        if (product.shortDescription.toLowerCase().includes(lowerQuery)) {
          score += 3;
        }

        // Category matches
        if (
          product.categories.some((cat) =>
            cat.toLowerCase().includes(lowerQuery)
          )
        ) {
          score += 2;
        }

        return score;
      }

      function renderProducts() {
        const productsGrid = document.getElementById("productsGrid");
        const pagination = document.getElementById("pagination");
        const productCount = document.getElementById("productCount");
        const noResults = document.getElementById("noResults");

        // Get filtered and sorted products
        let filteredProducts = filterAndSortProducts();

        // Show/hide no results message
        if (filteredProducts.length === 0) {
          productsGrid.classList.add("hidden");
          noResults.classList.remove("hidden");
          pagination.innerHTML = "";
          productCount.textContent = "No products found";
          return;
        } else {
          productsGrid.classList.remove("hidden");
          noResults.classList.add("hidden");
        }

        // Calculate pagination
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        const startIndex = (currentPage - 1) * productsPerPage;
        const paginatedProducts = filteredProducts.slice(
          startIndex,
          startIndex + productsPerPage
        );

        // Render products
        productsGrid.innerHTML = paginatedProducts
          .map(
            (product) => `
        <div class="product-card bg-gray-800 rounded-lg shadow-lg overflow-hidden fade-in hover:transform hover:scale-105 transition duration-300">
            <div class="h-48 bg-gray-700 flex items-center justify-center relative overflow-hidden">
                ${
                  product.images && product.images.length > 0
                    ? `<img src="${product.images[0]}" alt="${product.title}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div class="w-full h-full flex items-center justify-center absolute inset-0" style="display: none;">
                         <i class="fas fa-box text-4xl text-gray-400"></i>
                       </div>`
                    : `<div class="w-full h-full flex items-center justify-center">
                         <i class="fas fa-box text-4xl text-gray-400"></i>
                       </div>`
                }
                ${
                  product.price === 0
                    ? `
                <span class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-sm font-semibold">
                    FREE
                </span>
                `
                    : ""
                }
            </div>
            <div class="p-4">
                <h3 class="text-xl font-semibold mb-2">${product.title}</h3>
                <p class="text-gray-400 mb-4">${product.shortDescription}</p>
                <div class="flex flex-wrap gap-2 mb-4">
                    ${product.categories
                      .map(
                        (cat) =>
                          `<span class="bg-blue-600 text-white px-2 py-1 rounded text-sm">${cat}</span>`
                      )
                      .join("")}
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-2xl font-bold ${
                      product.price === 0 ? "text-green-400" : "text-yellow-400"
                    }">
                        ${product.price === 0 ? "FREE" : `$${product.price}`}
                    </span>
                    <a href="product-detail.html?id=${product.id}" 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                        View Details
                    </a>
                </div>
            </div>
        </div>
    `
          )
          .join("");

        // Render pagination
        renderPagination(totalPages);

        // Update product count
        productCount.textContent = `Showing ${paginatedProducts.length} of ${filteredProducts.length} products`;
      }

      function renderPagination(totalPages) {
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        let paginationHTML = "";

        // Previous button
        if (currentPage > 1) {
          paginationHTML += `
            <button onclick="changePage(${currentPage - 1})" 
                    class="px-3 py-2 bg-gray-700 rounded hover:bg-blue-600 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
          `;
        }

        // Page numbers - show limited pages with ellipsis
        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust start page if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // First page and ellipsis
        if (startPage > 1) {
          paginationHTML += `
            <button onclick="changePage(1)" 
                    class="px-3 py-2 bg-gray-700 rounded hover:bg-blue-600 transition">
                1
            </button>
          `;
          if (startPage > 2) {
            paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
          }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
          if (i === currentPage) {
            paginationHTML += `
              <button class="px-3 py-2 bg-blue-600 rounded font-semibold">
                ${i}
              </button>
            `;
          } else {
            paginationHTML += `
              <button onclick="changePage(${i})" 
                      class="px-3 py-2 bg-gray-700 rounded hover:bg-blue-600 transition">
                ${i}
              </button>
            `;
          }
        }

        // Last page and ellipsis
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
          }
          paginationHTML += `
            <button onclick="changePage(${totalPages})" 
                    class="px-3 py-2 bg-gray-700 rounded hover:bg-blue-600 transition">
              ${totalPages}
            </button>
          `;
        }

        // Next button
        if (currentPage < totalPages) {
          paginationHTML += `
            <button onclick="changePage(${currentPage + 1})" 
                    class="px-3 py-2 bg-gray-700 rounded hover:bg-blue-600 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
          `;
        }

        pagination.innerHTML = paginationHTML;
      }

      function changePage(page) {
        currentPage = page;
        renderProducts();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function setupFilters() {
        const categoryFilter = document.getElementById("categoryFilter");
        const sortSelect = document.getElementById("sortSelect");
        const clearFilters = document.getElementById("clearFilters");

        categoryFilter.addEventListener("change", () => {
          currentPage = 1;
          renderProducts();
        });

        sortSelect.addEventListener("change", () => {
          currentPage = 1;
          renderProducts();
        });

        clearFilters.addEventListener("click", () => {
          categoryFilter.value = "all";
          sortSelect.value = "name";
          currentSearchQuery = "";
          document.getElementById("searchInput").value = "";
          document.getElementById("navSearch").value = "";
          currentPage = 1;

          // Clear URL parameters by reloading without them
          if (getUrlParams().category) {
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );
          }

          renderProducts();
          updateSearchInfo();
        });
      }

      document.addEventListener("DOMContentLoaded", loadProductsPage);
    </script>
  </body>
</html>
